# ARCHITECTURE.md

## 1. Основные принципы

Архитектура приложения основана на официальных рекомендациях Google и следует принципу **Разделения ответственности (Separation of Concerns)**. Это многослойная архитектура (Layered Architecture), реализующая паттерн **MVVM (Model-View-ViewModel)**.

Такой подход обеспечивает высокую модульность, упрощает тестирование и дальнейшее сопровождение кода. Каждый слой имеет четко определенную зону ответственности и минимально зависит от других слоев.

## 2. Структура слоев

Приложение состоит из двух основных логических слоев: **UI Layer** и **Data Layer**.

### 2.1. UI Layer (Слой интерфейса)

Отвечает за отображение данных на экране и обработку взаимодействий с пользователем.

*   **Components:**
    *   **Views (Composable functions):** Экраны, созданные с помощью Jetpack Compose. Являются "пассивными" и не содержат логики, кроме отображения состояния. Они подписываются на изменения состояния в `ViewModel` и передают ей события от пользователя (клики, жесты).
        *   `ui/GalleryScreen.kt` - главный экран с галереей контента
        *   `ui/SeriesDetailsScreen.kt` - экран с деталями сериала и списком эпизодов
        *   `ui/PlayerScreen.kt` - экран видеоплеера на базе ExoPlayer
        *   `ui/SettingsScreen.kt` - экран настроек
        *   `ui/PinDialog.kt` - диалог ввода PIN-кода
        *   `ui/Navigation.kt` - навигация между экранами
    *   **ViewModel:** Является владельцем и поставщиком состояния для UI. Обрабатывает события от UI, запрашивает данные у `Data Layer` и предоставляет `StateFlow` с готовым для отображения состоянием. `ViewModel` не имеет прямых ссылок на Composable-функции.
        *   `ui/GalleryViewModel.kt` - управление состоянием галереи
        *   `ui/PlayerViewModel.kt` - управление состоянием плеера и извлечением видеоссылок

*   **Технологии:** Jetpack Compose, ViewModel, StateFlow, Coroutines, ExoPlayer.

### 2.2. Data Layer (Слой данных)

Отвечает за предоставление данных приложению, абстрагируя источники и логику их получения.

*   **Components:**
    *   **Repository (Репозиторий):** Единственная точка входа (Single Source of Truth) для `UI Layer`. Инкапсулирует логику работы с данными: определяет, когда запрашивать данные из сети, а когда из кеша, и управляет кешированием.
        *   `data/ContentRepository.kt` - репозиторий для работы с контентом
    *   **Data Sources (Источники данных):**
        *   **Remote Data Source (Сетевой источник):** Отвечает за выполнение всех сетевых операций: загрузка JSON-файла с контентом, загрузка и парсинг HTML-страниц видеохостингов.
            *   `data/RemoteDataSource.kt` - сетевой источник данных
        *   **Local Data Source (Локальный источник):** Отвечает за кеширование данных на устройстве (чтение и запись JSON-файла во внутреннее хранилище).
            *   `data/LocalDataSource.kt` - локальный источник данных (файловый кеш)
    *   **Parsers (Парсеры):** Специализированные компоненты для извлечения прямых ссылок на видео из различных видеохостингов.
        *   `data/parsers/VideoParser.kt` - интерфейс парсера видео
        *   `data/parsers/OkRuParser.kt` - парсер для ok.ru
        *   `data/parsers/VkVideoParser.kt` - парсер для vkvideo.ru
        *   `data/parsers/VideoParserFactory.kt` - фабрика для создания нужного парсера
    *   **Settings (Настройки):**
        *   `data/SettingsManager.kt` - управление настройками приложения

*   **Технологии:** OkHttp, Jsoup, Moshi, Kotlin Coroutines, файловое API.

### 2.3. Domain Layer (Доменные модели)

*   **Models (Модели данных):**
    *   `model/ContentData.kt` - модели данных контента:
        *   `ContentRoot` - корневая структура JSON
        *   `ContentItem` - элемент контента (фильм или сериал)
        *   `Episode` - эпизод сериала
    *   `model/Constants.kt` - константы приложения (URL контента, PIN-код)

## 3. Диаграмма архитектуры

```
+------------------------------------------------+
|                   UI Layer                     |
|                                                |
|   +--------------+   (Events)    +-----------+ |
|   |   Screen     | ------------> | ViewModel | |
|   | (Compose)    | <------------ | (StateFlow)| |
|   +--------------+  State Updates+-----------+ |
|   • GalleryScreen                • GalleryVM  | |
|   • PlayerScreen                 • PlayerVM   | |
|   • SeriesDetailsScreen                       | |
|   • SettingsScreen                            | |
+--------------------|---------------------------+
                     | (Request Data)
                     v
+--------------------|---------------------------+
|                 Data Layer                     |
|                    |                           |
|             +------v--------+                  |
|             |  Repository   |                  |
|             | ContentRepo   |                  |
|             +---------------+                  |
|              /             \                   |
|             /               \                  |
|   +-------------------+  +------------------+  |
|   | RemoteDataSource  |  | LocalDataSource  |  |
|   | • OkHttp          |  | • File Cache     |  |
|   | • Parsers Factory |  | • JSON Storage   |  |
|   |   - OkRuParser    |  +------------------+  |
|   |   - VkVideoParser |                        |
|   +-------------------+  +------------------+  |
|                          | SettingsManager  |  |
|                          +------------------+  |
+------------------------------------------------+
                     |
                     v
+------------------------------------------------+
|               Domain Layer                     |
|                                                |
|   +------------------+  +-------------------+  |
|   | Model Classes    |  | Constants         |  |
|   | • ContentRoot    |  | • DEFAULT_URL     |  |
|   | • ContentItem    |  | • PARENTAL_PIN    |  |
|   | • Episode        |  +-------------------+  |
|   +------------------+                         |
+------------------------------------------------+
```

## 4. Потоки данных (Data Flows)

### 4.1. Получение списка контента

1.  **UI (Screen):** При старте экрана вызывается метод `ViewModel`.
2.  **ViewModel:** Запускает корутину и вызывает метод `getContent()` у `Repository`.
3.  **Repository:**
    a. Запускает две асинхронные задачи: одна для получения данных из `Local DataSource`, другая из `Remote DataSource`.
    b. Сначала возвращает `ViewModel` данные из `Local DataSource` (из кеша) для мгновенного отображения.
    c. После получения данных от `Remote DataSource`, сравнивает их с кешем.
    d. Если данные из сети новые, обновляет кеш через `Local DataSource` и возвращает свежие данные `ViewModel`.
4.  **ViewModel:** Получает данные, преобразует их в `UiState` (модель состояния для экрана) и обновляет `StateFlow`.
5.  **UI (Screen):** Будучи подписанным на `StateFlow`, автоматически получает новое состояние и перерисовывает список контента.

### 4.2. Получение ссылки на видео и воспроизведение

1.  **UI (Screen):** Пользователь нажимает на элемент списка. Событие передается в `ViewModel`.
2.  **ViewModel:** Вызывает метод `getVideoUrl(pageUrl)` у `Repository`.
3.  **Repository:** Делегирует вызов `Remote DataSource`.
4.  **Remote DataSource:**
    a. Выполняет HTTP-запрос к `pageUrl` с помощью `OkHttp`.
    b. Парсит полученный HTML с помощью `Jsoup` для извлечения прямой ссылки на видео.
    c. Возвращает ссылку `Repository`.
5.  **Repository:** Возвращает ссылку `ViewModel`.
6.  **ViewModel:** Обновляет `UiState`, добавляя в него полученную ссылку на видео.
7.  **UI (Screen):** Получает новое состояние и передает ссылку компоненту `ExoPlayer` для начала воспроизведения.

## 5. Физическая структура файлов

```
app/src/main/java/com/example/childrenmovie/
├── MainActivity.kt                      # Главная Activity приложения
│
├── ui/                                  # UI Layer - Интерфейс
│   ├── GalleryScreen.kt                # Главный экран с галереей контента
│   ├── GalleryViewModel.kt             # ViewModel для галереи
│   ├── SeriesDetailsScreen.kt          # Экран деталей сериала
│   ├── PlayerScreen.kt                 # Экран видеоплеера (ExoPlayer)
│   ├── PlayerViewModel.kt              # ViewModel плеера
│   ├── SettingsScreen.kt               # Экран настроек
│   ├── PinDialog.kt                    # Диалог ввода PIN-кода
│   ├── Navigation.kt                   # Навигация между экранами
│   └── theme/                          # Тема оформления
│       ├── Color.kt
│       ├── Type.kt
│       └── Theme.kt
│
├── data/                                # Data Layer - Данные
│   ├── ContentRepository.kt            # Репозиторий контента (SSOT)
│   ├── RemoteDataSource.kt             # Сетевой источник данных
│   ├── LocalDataSource.kt              # Локальный источник (файловый кеш)
│   ├── SettingsManager.kt              # Управление настройками
│   └── parsers/                        # Парсеры видеохостингов
│       ├── VideoParser.kt              # Интерфейс парсера
│       ├── OkRuParser.kt               # Парсер для ok.ru
│       ├── VkVideoParser.kt            # Парсер для vkvideo.ru
│       └── VideoParserFactory.kt       # Фабрика парсеров
│
└── model/                               # Domain Layer - Модели
    ├── ContentData.kt                  # Модели данных (ContentRoot, ContentItem, Episode)
    └── Constants.kt                    # Константы приложения
```

## 6. Ключевые технологические решения

*   **UI:** **Jetpack Compose** выбран для современного, декларативного и эффективного построения пользовательского интерфейса.
*   **Видеоплеер:** **ExoPlayer (Media3)** используется для воспроизведения видео с поддержкой различных форматов и продвинутым управлением.
*   **Асинхронность:** **Kotlin Coroutines** и **Flow** используются во всех слоях для управления асинхронными операциями, обеспечивая отзывчивость UI и эффективную работу с сетью и диском.
*   **Внедрение зависимостей (Dependency Injection):** Используется ручное внедрение зависимостей (Manual DI) для простоты. Репозиторий создается и передается в `ViewModel` через фабрику.
*   **Состояние UI:** Управление состоянием в `ViewModel` осуществляется с помощью `StateFlow`, что обеспечивает предсказуемый и реактивный поток данных к UI.
*   **Парсинг видео:** Модульная система парсеров с фабрикой для поддержки различных видеохостингов (ok.ru, vkvideo.ru).
