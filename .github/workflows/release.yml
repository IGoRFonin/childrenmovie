name: Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "VERSION_NAME=${TAG}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${TAG}"

      - name: Increment VERSION_CODE
        id: increment_version
        run: |
          CURRENT_VERSION_CODE=$(grep "VERSION_CODE=" gradle.properties | cut -d'=' -f2)
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          echo "NEW_VERSION_CODE=${NEW_VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "Incremented VERSION_CODE from ${CURRENT_VERSION_CODE} to ${NEW_VERSION_CODE}"

      - name: Update gradle.properties
        run: |
          sed -i "s/VERSION_NAME=.*/VERSION_NAME=${{ steps.version.outputs.VERSION_NAME }}/" gradle.properties
          sed -i "s/VERSION_CODE=.*/VERSION_CODE=${{ steps.increment_version.outputs.NEW_VERSION_CODE }}/" gradle.properties
          cat gradle.properties

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Sign APK
        id: sign_apk
        uses: r0adkll/sign-android-release@v1
        env:
          BUILD_TOOLS_VERSION: '34.0.0'
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Rename APK
        run: |
          mv ${{ steps.sign_apk.outputs.signedReleaseFile }} app/build/outputs/apk/release/app-release.apk

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: app/build/outputs/apk/release/app-release.apk
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Update content.json
        run: |
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.apk"
          VERSION="${{ steps.version.outputs.VERSION_NAME }}"

          # Update content.json with new version and URL
          jq --arg version "$VERSION" --arg url "$RELEASE_URL" \
            '.apkVersion = $version | .apkUrl = $url | .version += 1' \
            content.json > content.json.tmp
          mv content.json.tmp content.json

          cat content.json

      - name: Commit updated files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add gradle.properties content.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION_NAME }} (build ${{ steps.increment_version.outputs.NEW_VERSION_CODE }})"
          git push origin HEAD:main
