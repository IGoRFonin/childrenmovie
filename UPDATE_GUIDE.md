# Руководство по автообновлению приложения

## Обзор

Система автообновления позволяет обновлять приложение без использования Google Play Store. Пользователь может проверить наличие обновления в настройках приложения, скачать новую версию APK и установить её.

## Как это работает

1. **Проверка обновления**: Приложение запрашивает удаленный JSON-файл с контентом, который теперь содержит информацию о последней версии APK
2. **Сравнение версий**: Текущая версия приложения сравнивается с версией из JSON
3. **Загрузка APK**: Если доступна новая версия, пользователь может скачать APK через DownloadManager
4. **Установка**: После загрузки пользователь может установить обновление (требуется ручное подтверждение)

## Настройка удаленного JSON

Добавьте в ваш JSON-файл с контентом следующие поля:

```json
{
  "version": 1.0,
  "content": [...],
  "apkVersion": "1.0.5",
  "apkUrl": "https://github.com/username/repo/releases/download/v1.0.5/app-release.apk"
}
```

### Поля:

- **apkVersion** (optional, string) - Версия APK в формате "X.Y.Z" (например, "1.0.5")
- **apkUrl** (optional, string) - Прямая ссылка на скачивание APK-файла

## Подготовка релиза на GitHub

### 1. Создайте релиз на GitHub

```bash
# Создайте тег версии
git tag v1.0.5
git push origin v1.0.5

# Создайте релиз через GitHub UI или gh CLI
gh release create v1.0.5 app/build/outputs/apk/release/app-release.apk \
  --title "Версия 1.0.5" \
  --notes "Описание изменений"
```

### 2. Получите прямую ссылку на APK

После создания релиза ссылка будет в формате:
```
https://github.com/username/repo/releases/download/v1.0.5/app-release.apk
```

### 3. Обновите JSON-файл

Обновите поля `apkVersion` и `apkUrl` в вашем удаленном JSON-файле:

```json
{
  "version": 1.1,
  "content": [...],
  "apkVersion": "1.0.5",
  "apkUrl": "https://github.com/username/repo/releases/download/v1.0.5/app-release.apk"
}
```

## Использование для пользователя

1. Откройте настройки приложения (долгое нажатие на заголовок + PIN-код)
2. Прокрутите вниз до секции "Обновление приложения"
3. Нажмите "Проверить обновление"
4. Если обновление доступно, нажмите "Скачать и установить"
5. Дождитесь завершения загрузки
6. Нажмите "Установить" и подтвердите установку в системном диалоге

## Изменение версии приложения

При создании нового релиза обновите версию в `app/build.gradle.kts`:

```kotlin
defaultConfig {
    applicationId = "com.example.childrenmovie"
    versionCode = 2  // Увеличьте целое число
    versionName = "1.0.5"  // Измените версию в формате X.Y.Z
}
```

## Требования

- **Android 8.0 (API 26)+**: Разрешение `REQUEST_INSTALL_PACKAGES`
- **Интернет**: Для загрузки APK-файла
- **Хранилище**: Для сохранения скачанного APK

## Безопасность

- APK должен быть подписан тем же ключом, что и установленная версия
- Система Android запросит подтверждение установки у пользователя
- Автоматическая установка невозможна (ограничение платформы)

## Ограничения

1. **Ручное подтверждение**: Пользователь должен вручную подтвердить установку
2. **Одинаковая подпись**: APK должен быть подписан тем же сертификатом
3. **Только обновления**: Невозможно понизить версию приложения

## Альтернативные источники APK

Вместо GitHub можно использовать:
- **GitLab Releases**
- **Прямой хостинг** на вашем сервере
- **Другие CDN** с прямыми ссылками на APK

Главное требование - прямая ссылка на скачивание APK-файла.

## Структура файлов проекта

### Новые файлы:
- `data/UpdateRepository.kt` - Проверка обновлений
- `utils/ApkInstaller.kt` - Загрузка и установка APK
- `ui/UpdateViewModel.kt` - Управление состоянием обновления
- `res/xml/file_paths.xml` - Конфигурация FileProvider

### Измененные файлы:
- `model/ContentData.kt` - Добавлены поля `apkVersion` и `apkUrl`
- `data/SettingsManager.kt` - Хранение последней проверенной версии
- `ui/SettingsScreen.kt` - UI для автообновления
- `AndroidManifest.xml` - Permissions и FileProvider
- `app/build.gradle.kts` - Включен buildConfig
